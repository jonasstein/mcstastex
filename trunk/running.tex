% Emacs settings: -*-mode: latex; TeX-master: "manual.tex"; -*-

\chapter{Running \MCS}
\label{c:running}
This chapter describes usage of the McStas simulation package. Refer
to Chapter \ref{s:install} for installation instructions. In case of
problems regarding installation or usage, the McStas mailing
list~\cite{mcstas_webpage} or the authors should be contacted.

To use \MCS, an instrument
definition file describing the instrument to be simulated must be
written. Alternatively, an example instrument file can be obtained
from the \verb+examples/+ directory in the distribution or from
another source. 

The structure of \MCS\ is illustrated in Figure~\ref{fig:structure}.

The input files (instrument and component files) are written in the \MCS\
meta-language and are edited either by using your favourite editor
or by using the built in editor of the graphical user interface
(\texttt{mcgui}). 

Next, the instrument and component files are compiled using the \MCS\ compiler
using the FLEX and Bison facilities to produce a C program\footnote{Note that
since release \version\ of \MCS, FLEX and Bison need not be installed
on your computer.}. 

The resulting C program can then be
compiled with a C compiler and run in combination with various
front-end programs for example to present the intensity at the
detector as a motor position is varied.

The output data may be analyzed in the same way as regular experiments
are analyzed by using Matlab, Scilab~\cite{scilab_webpage} or IDL or by using the Perl routines included in \MCS .\index{Tools}

\begin{figure}[htb!]
\begin{center}
\input{figures/mcstas_software}
\end{center}
\caption{An illustration of the structure of \MCS\ .}
\label{fig:structure}
\end{figure}

\section{Brief introduction to the graphical user interface}
\label{s:brief}

This section gives an ultra-brief overview of how to use \MCS\ once it
has been properly installed. It is intended for those who do not read
manuals if they can avoid it. For details on the different steps, see
the following sections. This section uses the
\verb+vanadium_example.instr+ file supplied in the \verb+examples/+
directory of the \MCS\ distribution. %, see appendix~\ref{a:vanadium_example.instr}.

To start the graphical user interface of McStas, run the command
\verb+mcgui+ (\verb+mcgui.pl+ on Windows). This will open a window with some menus etc.,
see figure~\ref{fig:mcgui}. \index{Tools!mcgui}
\begin{figure}[htb!]
  \begin{center}
    \includegraphics[width=0.55\textwidth]{figures/mcgui.eps}
  \end{center}
\caption{The graphical user interface \texttt{mcgui}.}
\label{fig:mcgui}
\end{figure}

To load an instrument, select ``Open instrument'' from the ``File''
menu. Open the file \verb+vanadium_example.instr+ in the McStas
distribution. Next, check that the current plotting backend setting
(select ``Choose backend'' from the ``Simulation'' menu) corresponds
to your system setup. The default setting can be adjusted as explained in Chapter \ref{installing}
\begin{itemize} 
\item{by editing
the \verb+tools/perl/mcstas_config.perl+ setup file of your
installation}
\item{by setting the \verb+MCSTAS_FORMAT+ environment
variable.}
\end{itemize} \index{Environment variable!MCSTAS\_FORMAT}
Next, select ``Run simulation'' from the ``Simulation'' menu.
McStas will translate the definition into an executable program and pop
up a dialog window. Type a value for the ``ROT'' parameter ({\em e.g.}
90), check the ``Plot results'' option, and select ``Start''. The
simulation will run, and when it finishes after a while the results will
be plotted in a window. Depending on your chosen plotting backend, the
presented graphics will resemble one of those shown in figure \ref{fig:mcplot_figs}.
\begin{figure}[htb!]
  \begin{center}
    \includegraphics[angle=-90,width=0.49\textwidth]{figures/mcplot_PGPLOT.ps}
    \includegraphics[angle=-90,width=0.49\textwidth]{figures/mcplot_Scilab.eps}
    \includegraphics[width=0.49\textwidth]{figures/mcplot_Matlab.eps}
  \end{center}
\caption{Output from \texttt{mcplot} with PGPLOT, Scilab and Matlab backends}
\label{fig:mcplot_figs}
\end{figure}
When using the Scilab or Matlab backends, full 3D view of plots and
different display possibilities are available. Use the attached \MCS\
window menus to control these. Features are quite self
explanatory. For other options, execute \verb+mcplot --help+
(\verb+mcplot.pl --help+ on windows) to get help. 


To debug the simulation graphically, repeat the
steps but check the ``Trace'' option instead of the ``Simulate'' option.
A window will pop up showing a sketch of the instrument. 
Depending on your
chosen plotting backend, the presented graphics will resemble one of
those shown in figures \ref{fig:mcdisp_PGPLOT}-\ref{fig:mcdisp_Matlab}.
\begin{figure}[htb!]
  \begin{center}
    \includegraphics[width=0.55\textwidth]{figures/mcdisplay_PGPLOT.ps}
  \end{center}
\caption{Output from \texttt{mcdisplay} with PGPLOT backend. 
  The left mouse button starts a new neutron, the middle button zooms, and
  the right button resets the zoom. The Q key quits the program.}
\label{fig:mcdisp_PGPLOT}
\end{figure}
\begin{figure}[htb!]
  \begin{center}
    \includegraphics[width=0.55\textwidth]{figures/mcdisplay_Scilab.ps}
    \includegraphics[width=0.25\textwidth]{figures/mcdisplay_Scilab_dialog.ps}
  \end{center}
\caption{Output from \texttt{mcdisplay} with Scilab backend. Display
  can be adjusted using the dialogbox (right).}
\label{fig:mcdisp_Scilab}
\end{figure}
\begin{figure}[htb!]
  \begin{center}
    \includegraphics[width=0.55\textwidth]{figures/mcdisplay_Matlab.eps}
  \end{center}
\caption{Output from \texttt{mcdisplay} with Matlab backend. Display
  can be adjusted using the window buttons.}
\label{fig:mcdisp_Matlab}
\end{figure}

For a slightly longer gentle introduction to McStas, see the McStas
tutorial (available from~\cite{mcstas_webpage}). For more technical
details, read on from section~\ref{s:running}

\subsection{New releases of \MCS}
Releases of new versions of a software can today be carried out more or less
continuously. However, users do not update their software on a daily basis,
and as a compromise we have adopted the following policy of \MCS\ .

\begin{itemize}
\item A version {\version}.x will contain bug fixes and new functionality. A new manual
will, however, not be released and the modifications are documented on the
\MCS\ web-page. The extensions of the forthcoming version {\version}.x are also listed
on the web, and new versions may be released quite frequently when it is requested
by the user community.
\item A version 1.8 will contain an updated manual. It will typically be released
once or twice a year in connection to for example a \MCS\ workshop.
\end{itemize}

\section{Running the instrument compiler}
\label{s:running}

This section describes how to run the McStas compiler manually. Often,
it will be more convenient to use the front-end program \verb+mcgui+
(section~\ref{s:mcgui}) or \verb+mcrun+ (section~\ref{s:mcrun}). These
front-ends will compile and run the simulations automatically.
\index{Tools!mcgui} \index{Tools!mcrun}

The compiler for the \MCS{} instrument definition 
is invoked by typing a command of the form
\begin{verbatim}
    mcstas name.instr
\end{verbatim}
This will read the instrument definition \verb+name.instr+ which is
written in the \MCS\ meta-language. The compiler will translate the
instrument definition into a Monte Carlo simulation program provided in
ANSI-C. The output is by default written to a file in the current
directory with the same name as the instrument file, but with extension
\verb+.c+ rather than \verb+.instr+. This can be overridden using the
\verb+-o+ option as follows:
\begin{verbatim}
    mcstas -o code.c name.instr
\end{verbatim}
which gives the output in the file \verb+code.c+.
A single dash `\verb+-+' may be used for both input and output filename
to represent standard input and standard output, respectively.


\subsection{Code generation options}
\index{Code generation options}

By default, the output files from the \MCS\ compiler are in ANSI-C with
some extensions (currently the only extension is the creation of new
directories, which is not possible in pure ANSI-C). The use of
extensions may be disabled with the \verb+-p+ or \verb+--portable+
option. With this option, the output is strictly ANSI-C compliant, at
the cost of some slight reduction in capabilities.

The \verb+-t+ or \verb+--trace+ option puts special ``trace'' code in
the output. This code makes it possible to get a complete trace of the
path of every neutron through the instrument, as well as the position
and orientation of every component. This option is mainly used with the
\verb+mcdisplay+ front-end as described in section~\ref{s:mcdisplay}.

The code generation options can also be controlled by using preprocessor
macros in the C compiler, without the need to re-run the \MCS\
compiler. If the preprocessor macro \verb+MC_PORTABLE+ is defined, the
same result is obtained as with the \verb+--portable+ option of the
\MCS\ compiler. The effect of the \verb+--trace+ option may be obtained
by defining the \verb+MC_TRACE_ENABLED+ macro. Most Unix-like C
compilers allow preprocessor macros to be defined using the \verb+-D+
option, eg.
\begin{verbatim}
    cc -DMC_TRACE_ENABLED -DMC_PORTABLE ...
\end{verbatim}
Finally, the \verb+--verbose+ option will list the components and libraries beeing
included in the instrument.

\subsection{Specifying the location of files}
\label{s:files}

The \MCS\ compiler needs to be able to find various files during
compilation, some explicitly requested by the user (such as component
definitions and files referenced by \verb+%include+), \index{Keyword!\%include}
and some used internally to generate the simulation executable. \MCS\ looks for these
files in three places: first in the current directory, then in a list of
directories given by the user, and finally in a special \MCS\
directory. Usually, the user will not need to worry about this as \MCS\
will automatically find the required files. But if users build their own
component library in a separate directory or if \MCS\ is installed in an
unusual way, it will be necessary to tell the compiler where to look
for the files.

\index{Library!Components}
The location of the special \MCS\ directory is set when \MCS\ is
compiled. It defaults to \verb+/usr/local/lib/mcstas+ on Unix-like systems and \verb+C:\mcstas\lib+ on Windows systems, but it can be
changed to something else, see section~\ref{s:install} for
details. The location can be overridden by setting the environment
variable \verb+MCSTAS+: \index{Environment variable!MCSTAS}
\begin{verbatim}
    setenv MCSTAS /home/joe/mcstas
\end{verbatim}
for csh/tcsh users, or
\begin{verbatim}
    export MCSTAS=/home/joe/mcstas
\end{verbatim}
for bash/Bourne shell users.

To make \MCS\ search additional directories for component definitions
and include files, use the \verb+-I+ switch for the \MCS\ compiler:
\begin{verbatim}
    mcstas -I/home/joe/components -I/home/joe/neutron/include name.instr
\end{verbatim}
Multiple \verb+-I+ options can be given, as shown.


\subsection{Embedding the generated simulations in other programs}

By default, \MCS\ will generate a stand-alone C program, which is what
is needed in most cases. However, for advanced usage, such as embedding
the generated simulation in another program or even including two or
more simulations in the same program, a stand-alone program is not
appropriate. For such usage, the \MCS\ compiler provides the following
options:
\begin{itemize}
\item \verb+--no-main+ This option makes \MCS\ omit the \verb+main()+
  function in the generated simulation program. The user must then
  arrange for the function \verb+mcstas_main()+ to be called in some
  way.
\item \verb+--no-runtime+ Normally, the
  generated simulation program contains all the run-time C code necessary for
  declaring functions, variables, etc. used during the simulation.  This
  option makes \MCS\ omit the run-time code from the generated
  simulation program, and the user must then explicitly link with the file
  \verb+mcstas-r.c+ as well as other shared libraries from the \MCS{} distribution. 
  \index{Library!Run-time}
\end{itemize}
Users that need these options are encouraged to contact the authors for
further help.


\subsection{Running the C compiler}
\label{s:compile}

After the source code for the simulation program has been generated with
the \MCS\ compiler, it must be compiled with the C compiler to produce
an executable. The generated C code obeys the ANSI-C standard, so it
should be easy to compile it using any ANSI-C (or C++) compiler. \textit{E.g}.\ a
typical Unix-style command would be
\begin{verbatim}
    cc -O -o name.out name.c -lm
\end{verbatim}
The \verb+-O+ option typically enables the optimization phase of the compiler,
which can make quite a difference in speed of \MCS\ generated simulations. The
\verb+-o name.out+ sets the name of the generated executable. The \verb+-lm+
options is needed on many systems to link in the math runtime library (like the
$\cos()$ and $\sin()$ functions). \index{Simulation optimization}

Monte Carlo simulations are computationally intensive, and it is
often desirable to have them run as fast as possible. Some success can
be obtained by adjusting the compiler optimization
options. Here are some example platform and compiler combinations that
have been found to perform well (up-to-date information will be
available on the \MCS\ WWW home page~\cite{mcstas_webpage}):
\begin{itemize}
\item Intel x86 (``PC'') with Linux and GCC, using options \verb+gcc -O3+.
\item Intel x86 with Linux and EGCS (GCC derivate) using
  options \verb+egcc -O6+.
\item Intel x86 with Linux and PGCC (pentium-optimized GCC derivate), using
  options \verb+gcc -O6 -mstack-align-double+.
\item HPPA machines running HPUX with the optional ANSI-C compiler,
  using the options
  \verb|-Aa +Oall -Wl,-a,archive| (the \verb+-Aa+ option is necessary to
  enable the ANSI-C standard).
\item SGI machines running Irix with the options
  \verb|-Ofast -o32 -w|
\end{itemize}
A warning is in place here: it is tempting to spend far more time
fiddling with compiler options and benchmarking than is actually saved
in computation times. Even worse, compiler optimizations are notoriously
buggy; the options given above for PGCC on Linux and the ANSI-C compiler
for HPUX have been known to generate \emph{incorrect code} in some
compiler versions. \MCS\ actually puts an effort into making the task of the C compiler
easier, by in-lining code and using variables in an efficient way. As a
result, \MCS\ simulations generally run quite fast, often fast enough
that further optimizations are not worthwhile. Also, optimizations are higly
time and memory comsuming during compilation, and thus may fail when dealing
with large instrument descriptions (e.g. more that 100 elements). The compilation process is simplified when using components of the library making use of shared libraries (see \verb+SHARE+ keyword in chapter~\ref{s:kernel}).

\section{Running the simulations}
\label{s:run-sim}

Once the simulation program has been generated by the \MCS\ compiler
and an executable has been obtained with the C compiler, the simulation
can be run in various ways. The simplest way is to run it directly from the
command line or shell:
\begin{verbatim}
    ./name.out
\end{verbatim}
Note the leading dot, which is needed if the current directory is not in
the path searched by the shell. When used in this way, the simulation
will prompt for the values of any instrument parameters such as motor
positions, and then run the simulation.  
This way of running \MCS\ will only give data for one spectrometer
setting which is normally sufficient {\em e.g.} for a time-of-flight
spectrometer, but not for a triple-axis spectrometer where a scan over
various spectrometer settings is required.
Often the simulation will be run using one of several
available front-ends, as described in the next section. These front-ends
help manage output from the potentially many detectors in the
instruments, as well as running the simulation for each data point in
a scan.

The generated simulations accept a number of options and arguments. The
full list can be obtained using the \verb+--help+ option:
\begin{verbatim}
    ./name.out --help
\end{verbatim}
The values of instrument parameters may be specified as arguments using
the syntax \textit{name}\verb+=+\textit{val}. For example
\begin{verbatim}
    ./vanadium_example.out ROT=90
\end{verbatim}
The number of neutron histories to simulate may be set using the
\verb+--ncount+ or \verb+-n+ option, for example
\verb+--ncount=2e5+. The initial seed for the random number generator is
by default chosen based on the current time so that it is different for
each run. However, for debugging purposes it is sometimes convenient to
use the same seed for several runs, so that the same sequence of random
numbers is used each time. To achieve this, the random seed may be set
using the \verb+--seed+ or \verb+-s+ option.

By default, \MCS\ simulations write their results into several data files in the
current directory, overwriting any previous files stored there. The
\verb+--dir=+\textit{dir} or \verb+-d+\textit{dir} option causes the files to be
placed instead in a newly created directory \textit{dir} (to prevent overwriting
previous results an error message is given if the directory already exists).
Alternatively, all output may be written to a single file \textit{file} using
the \verb+--file=+\textit{file} or \verb+-f+\textit{file} option (which should probably be avoided when saving in binary format, see below).

The complete list of options
and arguments accepted by \MCS\ simulations appears in
table~\ref{f:simoptions}.

\subsection{Choosing a data file format}

Data files contain header lines with information about the
simulation from which they originate. In case the data must be analyzed
with programs that cannot read files with such headers, they may be
turned off using the \verb+--data-only+ or \verb+-a+ option.
\index{Data format}

The format of the output files from \MCS\ simulations is described in
more detail in section~\ref{s:analyze}. It may be chosen either with \verb+--format=FORMAT+ for each simulation or globally by setting the MCSTAS\_FORMAT environment variable. \index{Environment variable!MCSTAS\_FORMAT}
The available format list is obtained using the \verb+--help+ option, and shown in table~\ref{t:formatoptions}.
\MCS\ can presently generate many formats, including the original \MCS /PGPLOT and the new Scilab and Matlab formats. All formats, except the \MCS /PGPLOT, may eventually support binary files, which are much smaller and faster to import, but are platform dependent. The simulation data file extensions are appended automatically, depending on the format. For example:
\begin{verbatim}
    ./vanadium_example.out ROT=90 --format="Scilab binary"
\end{verbatim} 
or more generally (for bash/Bourne shell users)
\begin{verbatim}
    export MCSTAS_FORMAT="Matlab"
    ./vanadium_example.out ROT=90
\end{verbatim}

\subsection{Basic import and plot of results}

The previous example will result in a \verb+mcstas.m+ file, that may be read directly from Matlab (using the {\it sim file} function)
\begin{verbatim}
    matlab> s=mcstas;
    matlab> s=mcstas('plot')
\end{verbatim} \index{Tools!Matlab}
The first line returns the simulation data as a single structure variable, whereas the second one will additionally plot each detector separately.
This also equivalently stands for Scilab (using the \verb+get_+{\it sim file} function, the 'exec' call is required in order to compile the code)
\begin{verbatim}
    scilab> exec('mcstas.sci', -1); s=get_mcstas();
    scilab> exec('mcstas.sci', -1); s=get_mcstas('plot')
\end{verbatim} \index{Tools!Scilab}
and for IDL
\begin{verbatim}
    idl> s=mcstas()
    idl> s=mcstas(/plot)
\end{verbatim} \index{Tools!IDL}
See section~\ref{s:mcplot} for an other way of plotting simulation results using the \verb+mcplot+ front-end. \index{Tools!mcplot}

\begin{table}
  \begin{center}
    {\let\my=\\
    \begin{tabular}{|p{0.24\textwidth}|p{0.7\textwidth}|}
      \hline
      \texttt{-s {\it seed}} \my \texttt{--seed={\it seed}}
        & Set the initial seed for the random number generator. This may be
        useful for testing to make each run use the same random number
      sequence. \\
      \hline
      \texttt{-n {\it count}} \my \texttt{--ncount={\it count}}
        & Set the number of neutron histories to simulate. The default
      is 1,000,000. \\
      \hline
      \texttt{-d {\it dir}} \my \texttt{--dir={\it dir}}
        & Create a new directory {\it dir\/} and put all data files in
      that directory. \\
      \hline
      \texttt{-f {\it file}} \my \texttt{--file={\it file}}
        & Write all data into a single file {\it file} \\
      \hline
      \texttt{-a} \my \texttt{--data-only}
        & Do not put any headers in the data files. \\
      \hline
      \texttt{-h} \my \texttt{--help}
        & Show a short help message with the options accepted, available formats
        and the names of the parameters of the instrument. \\
      \hline
      \texttt{-i} \my \texttt{--info}
        & Show extensive information on the simulation and the
      instrument definition it was generated from. \\
      \hline
      \texttt{-t} \my \texttt{--trace}
        & This option makes the simulation output the state of every
      neutron as it passes through every component. Requires that the
      \texttt{-t} (or \texttt{--trace}) option is also given to the
      \MCS\ compiler when the simulation is generated. \\
      \hline
      \texttt{--no-output-files}
        & This option disables the writing of data files (output to the
      terminal, such as detector intensities, will still be written). \\
      \hline
      \texttt{-g} \my \texttt{--gravitation}
        & This option toggles the gravitation handling for the whole neutron propagation within the instrument. \\
      \hline
      \texttt{--format={\it FORMAT}}
        & This option sets the data format for result files from monitors \\
      \hline
      \texttt{{\it param}{\texttt =}{\it value}}
        & Set the value of an instrument parameter, rather than having
        to prompt for each one. \\
      \hline
    \end{tabular}
    \caption{Options accepted by \MCS\ simulations}
    \label{f:simoptions}
    }
  \end{center}
\end{table}

\begin{table}
  \begin{center}
    {\let\my=\\
    \begin{tabular}{|p{0.24\textwidth}|c|p{0.7\textwidth}|}
      \hline
      \texttt{\MCS} \my \texttt{PGPLOT} & .sim & Original format for PGPLOT plotter (may be used with -f and -d options) \\
      \texttt{Scilab} & .sci & Scilab format (may be used with -f and -d options) \\
      \texttt{Scilab binary} & & Scilab format with external binary files (may be used with -d option). Also toggles -a option. \\
      \texttt{Matlab} & .m & Matlab format (may be used with -f and -d options) \\
      \texttt{Matlab binary} & & Matlab format with external binary files (may be used with -d option). Also toggles -a option. \\
      \texttt{IDL} & .pro & IDL format. {\em Must} be used with -f option. \\
      \texttt{IDL binary} & & IDL format with external binary files (may be used with -d option). Also toggles -a option. \\
      \texttt{XML} & .xml & XML/NeXus format (may be used with -f and -d options). \\
      \texttt{HTML} & .html & HTML format (generates a web page, may be used with -f and -d options).  \\
      \hline
    \end{tabular}
    \caption{Available formats supported by \MCS\ simulations.}
    \label{t:formatoptions}
    }
  \end{center}
\end{table}

\subsection{Interacting with a running simulation}
\index{Signal handler|textbf}

Once the simulation has started, it is possible, under Unix, Linux and Mac OS X systems, to interact with the on-going simulation. 

\MCS\ attaches a signal handler to the simulation process. In order to send a signal to the process, the process-id {\it pid} must be known. Users may look at their running processes with the Unix 'ps' command, or alternatively process managers like 'top' and 'gtop'.
If a {\it file.out} simulation obtained from \MCS\ is running, the process status command should output a line ressembling
\begin{quote}
  \verb|<user>| {\it 13277} \verb|7140 99 23:52 pts/2    00:00:13 | {\it file.out}\\
\end{quote}
where \verb+user+ is your loggin name. The {\it pid} is there '13277'.

Once known, it is possible to send one of the signals listed in table~\ref{t:signals} using the 'kill' unix command (or the functionalities of your process manager), e.g.
\begin{verbatim}
    kill -USR2 13277
\end{verbatim}
This will result in a message showing status (here 33 \% achieved), as well as the position in the instrument of the current neutron. 
\begin{verbatim}
# McStas: [pid 13277] Signal 12 detected SIGUSR2 (Save simulation)
# Simulation: file (file.instr)
# Breakpoint: MyDetector (Trace) 33.37 % (  333654.0/ 1000000.0)
# Date      : Wed May  7 00:00:52 2003
# McStas: Saving data and resume simulation (continue)
\end{verbatim}
followed by the list of detector outputs (integrated counts and files). Finally, sending a \verb+kill 13277+ (which is equivalent to \verb+kill -TERM 13277+) will end the simulation before the initial 'ncount' preset.

A typical usage example would be, for instance, to save data during a
simulation, plot or analyze it, and decide to interupt the simulation
earlier if the desired statistics has been achieved.

Whenever simulation data is generated before end (or the simulation is interupted), the 'ratio' field of the monitored data will provide the level of achievement of the computation (for instance '3.33e+05/1e+06');

Additionally, any system error will result in similar messages, giving indication about the occurence of the error (in which component ? in which section ?). Whenever possible, the simulation will {\em try} to save the data before ending. Most errors appear when writing a new component, in the \texttt{INITIALIZE}, \texttt{TRACE} or \texttt{FINALLY} sections. Memory errors usually show up when C pointers have not been allocated/unallocated before usage, whereas mathematical errors are set when, for instance, dividing per zero.

\begin{table}
  \begin{center}
    {\let\my=\\
    \begin{tabular}{|p{0.24\textwidth}|p{0.7\textwidth}|}
      \hline
      \texttt{USR1} & Request informations (status)  \\
      \texttt{USR2} & Request informations and performs an intermediate saving of all monitors (status and save). This triggers the execution of all \texttt{SAVE} sections (see chapter~\ref{s:kernel}).  \\
      \texttt{INT, TERM} & Save and exit before end (status)  \\
      \hline
    \end{tabular}
    \caption{Signals supported by \MCS\ simulations.}
    \label{t:signals}
    }
  \end{center}
\end{table}

\subsection{Optimizing a simulation}
\index{Simulation optimization}
There are various other ways to speed-up a simulation
\begin{itemize}
\item Optimize the compilation of the instrument, as explained in section~\ref{s:compile}.
\item Divide simulation into parts using a file for saving or generating neutron
      events. This way, a guide may be simulated only once, saving the neutron events 
      getting out from it as a file, which is being read quickly by the second simulation 
      part. Use the Virtual\_input and Virtual\_output components for this technique.
\item Use source optimizers like the components Source\_adapt or
      Source\_Optimizer. Such component may sometimes not be very efficient, when no
      neutron importance sampling can be achieved, or may even sometimes alter the
      simulation results. Be careful and always check results with a non-optimized 
      computation.
\item Complex components usually take into account additional small effects in a simulation,
      but are much longer to execute. Thus, simple components should be prefered
      whenever possible, at least to start with. 
\end{itemize}

Additionally, the user may wish to optimize the parameters of a simulation (e.g. find the optimal curvature of a monochromator, or the best geometry of a given component). 
The user should write a function script or a program that
\begin{itemize}
\item inputs the simulation parameters, which are usually numerical values such as $TT$ in the \verb+prisma2+ instrument from the \verb+examples+ directory of the package.
\item builds a command line from these parameters.
\item execute that command, and waits until the end of the computation.
\item reads the relevant data from the monitors.
\item outputs a simulation quality measurement from this data, usually the integrated counts or some peak width.
\end{itemize}

For instance, for the \verb+prisma2+ we could write a function for Matlab (see section~\ref{s:analyze} for details about the Matlab data format) in order to study the effects of the $TT$ parameter:
\begin{verbatim}
  function y = instr_value(p)
    TT = p(1);     % p may be a vector/matrix containing many parameters 
    syscmd = [ 'mcrun prisma2.instr -n1e5 TT=' num2str(TT) ...
               ' PHA=22 PHA1=-3 PHA2=-2 PHA3=-1 PHA4=0 PHA5=1'
               ' PHA6=2 PHA7=3 TTA=44 --format="Matlab"' ];
    system(syscmd); path(path) % execute simulation, and rehash files
    s = mcstas;     % get the simulation data, and the monitor data
    s = s.prisma2.m_mcstas.detector.prisma2_tof.signal;
    eval(s);        % we could also use the 'statistics' field
    y = -Mean;      % 'value' of the simulation
\end{verbatim}

Then a numerical optimization should be available, such as those provided with Matlab, Scilab, IDL, and Perl-PDL high level languages. In this example, we may wish to maximize the \verb+instr_value+ function value. The \verb+fminsearch+ function of Matlab is a minimization method (that's why we have a minus sign for $y$ value), and:
\begin{verbatim}
    matlab> TT = fminsearch('instr_value', -25)
\end{verbatim}
will determine the best value of TT, starting from -25 estimate, in order to minimize function \verb+instr_value+, and thus maximize the mean detector counts.

The choice of the optimization routine, of the simulation quality value to optimize 
and the initial parameter guess all may have a large influence on the results. 
Be cautious and wise when interpreting the optimal guess.

\section{Using simulation front-ends}
\label{s:frontends}

\MCS\ includes a number of front-end programs that extend the
functionality of the simulations. A front-end programs is an interface
between the user and the simulations, running the simulations and
presenting the output in various ways to the user.

The list of available \MCS\ front-end programs may be obtained from the \verb+mcdoc --tools+ command:
\begin{verbatim}
    McStas Tools
       mcstas        Main instrument compiler
       mcrun         Instrument maker and execution utility
       mcgui         Graphical User Interface instrument builder
       mcdoc         Component library documentation generator/viewer
       mcplot        Simulation result viewer
       mcdisplay     Instrument geometry viewer
       mcresplot     Instrument resolution function viewer
       mcstas2vitess McStas to Vitess component translation utility
    When used with the -h flag, all tools display a specific help.
    SEE ALSO: mcstas, mcdoc, mcplot, mcrun, mcgui, mcresplot, mcstas2vitess
    DOC:      Please visit http://neutron.risoe.dk/mcstas/
\end{verbatim}
An extended set of front-end programs is planned for future versions of
\MCS, including a NeXus data format option~\cite{nexus_webpage}.


\subsection{The graphical user interface (mcgui)}
\label{s:mcgui}
\index{Tools!mcgui|textbf}

The front-end \verb+mcgui+ provides a graphical user interface that
interfaces the various parts of the McStas package. It is started using
simply the command
\begin{verbatim}
    mcgui
\end{verbatim}
The mcgui program may optionally be given the name of an instrument file.

When the front-end is started, a main window is opened. This window
displays the output from compiling and running simulations, and also
contains a few menus and buttons. The main purpose of the front-end is
to edit and compile instrument definitions, run the simulations, and
visualize the results.

\subsubsection{The menus}

The ``File'' menu has the following features:
\begin{description}
\item[Open instrument] selects the name of an instrument file to be used.
\item[Edit current] opens a simple editor window for editing the
  current instrument definition. This function is also available from
  the ``Edit'' button to the right of the name of the instrument definition in
  the main window.
\item[Spawn editor] This starts the editor defined in the environment
  variable \verb+VISUAL+ or \verb+EDITOR+ on the current instrument
  file. It is also possible to start an external editor manually; in any
  case \verb+mcgui+ will recompile instrument definitions as necessary based on
  the modification dates of the files on the disk.
  \index{Environment variable!EDITOR}
\item[Compile instrument] forces a recompile of the instrument
  definition, regardless of file dates. This is for example useful to
  pick up changes in component definitions, which the front-end will not
  notice automatically. See section~\ref{s:install} for how to override
  default C compiler options.
\item[Clear output] erases all text in the window showing output of
  compilations and simulations.
\item[Quit] exits the graphical user interface front-end.
\end{description}

\noindent The ``Simulation'' menu has the following features:
\begin{description}
\item[Read old simulation] prompts for the name of a file
  from a previous run of a McStas simulation (usually called
  \verb+mcstas.sim+). The file will be read and any detector data
  plotted using the \verb+mcplot+ front-end. The parameters used in the
  simulation will also be made the defaults for the next simulation
  run. This function is also available using the ``Read'' button to the
  right of the name of the current simulation data.
\item[Run simulation] opens the run dialog window, explained
  further below.
\item[Plot results] plots (using \verb+mcplot+) the results of the
  last simulation run or loaded.
\item[Choose backend] selection of plotting backend
  (PGPLOT/Matlab/Scilab). Opens the choose backend dialogue shown in
  figure~\ref{fig:mcgui-choose}.
\end{description}
 \begin{figure}[htb!]
  \begin{center}
    \includegraphics[width=0.3\textwidth]{figures/choose_backend.eps}
  \end{center}
\caption{The choose backend dialog in \texttt{mcgui}.}
\label{fig:mcgui-choose}
\end{figure}

The ``Help'' menu has the following features, through use of
\verb+mcdoc+ and a web browser. To customize the used web browser, set
the \verb+BROWSER+ environment variable. If \verb+BROWSER+ is not set,
\verb+mcgui+ uses \verb+netscape+ on Unix and the default browser on
Windows.
\begin{description}
\item[\MCS\ web page] calls \verb+mcdoc --web+, brings up the \MCS\
  website in a web browser.
\item[\MCS\ manual] calls \verb+mcdoc --manual+, brings up the local
  pdf version of this manual, using a web browser.
\item[Component doc index] displays the component documentation using
  the component \verb+index.html+ index file.
\item[Generate component index] (re-)generates the component \verb+index.html+.
\end{description}
 single menu point, ``McStas web-page'', which
attempts to open a Netscape window with the McStas web-page. This
obviously requires that Netscape is properly installed on the computer.


\subsubsection{The run dialog}

\begin{figure}[htb!]
  \begin{center}
    \includegraphics[width=0.45\textwidth]{figures/mcgui-run.eps}
  \end{center}
\caption{The run dialog in \texttt{mcgui}.}
\label{fig:mcgui-run}
\end{figure}
%
The run dialog is used to run simulations. It allows the entry of
instrument parameters as well as the specifications of options for
running the simulation (see section~\ref{s:run-sim} for details). It
also allows to run the \verb+mcdisplay+ (section~\ref{s:mcdisplay}) and
\verb+mcplot+ (section~\ref{s:mcplot}) front-ends together with the
simulation.

The meaning of the different fields is as follows:
\begin{description}
\item[Instrument parameters] allows the setting of the values for
  the input parameters of the instrument. The type of each instrument
  parameter is given in parenthesis after each name. Floating point
  numbers are denoted by (D) (for the C type ``\verb+double+''), (I)
  denotes integer parameters, and (S) denotes strings.
\item[Output to] allows the entry of a directory to store the
  resulting data files in (like the \verb+--dir+ option). If no name is
  given, the results are put in the current directory, to be overwritten
  by the next simulation.
\item[Neutron count] sets the number of neutron histories to
  simulate (the \verb+--ncount+ option).
\item[Plot results] -- if checked, the \verb+mcplot+ front-end will be run
  after the simulation has finished, and the plot dialog will pop up
  (see below).
\item[Random seed/Set seed to] selects between using a random seed (different
  in each simulation) for the random number generator, or using a fixed
  seed (to reproduce results for debugging).
\item[Simulate/Trace] selects between running the simulation
  normally, or using the \verb+mcdisplay+ front-end.
\item[Start] runs the simulation.
\item[Cancel] aborts the dialog.
\end{description}

Before running the simulation, the instrument definition is
automatically compiled if it is newer than the generated C file (or if the C file
is newer than the executable). The executable is
assumed to have a \verb+.out+ suffix in the filename.


\subsubsection{The plot dialog}
\begin{description}
\item[Monitors and detectors] lists all the one- and
  two-dimensional detectors in the instrument. By double-clicking, one plots
  the data in the plot window.
\item[Plot] plots the selected detector in the plot window, just
  like double-clicking its name.
\item[Overview plot] plots all the detectors together in the plot
  window.
\item[B\&W postscript] prompts for a file name and saves the
  current plot as a black and white postscript file. This can
  subsequently be printed on a postscript printer.
\item[Colour postscript] creates a colour postscript file of the
  current plot.
\item[Close] ends the dialog.
\end{description}


\subsubsection{The editor window}

The editor window provides a simple editor for creating and modifying
instrument definitions. Apart from the usual editor functions, the
``Insert'' menu provides some functions that aid in the construction of
the instrument definitions:
\begin{description}
\item[Instrument template] inserts the text for a simple instrument
  skeleton in the editor window.
\item[Component\ldots] opens up a dialog window with a list of all
  the components available for use in McStas. Selecting a component will
  display a description. Double-clicking will open up a dialog window
  allowing the entry of the values of all the parameters for the
  component (figure~\ref{f:comp_dialog}). See section~\ref{s:instrdefs}
  for details of the meaning of the different fields.

The dialog will also pick up those of the users own components that are
  present in the current directory when \verb+mcgui+ is started. See
  section~\ref{s:mcdoc} for how to write components to integrate well
  with this facility.
\item[\textit{Type}] These menu entries give quick access to the entry
  dialog for the various components available.
\end{description}
\begin{figure}[tbp]
  \begin{center}
    \includegraphics[width=0.55\textwidth]{figures/comp_dialog.eps}
    \caption{Component parameter entry dialog.}
    \label{f:comp_dialog}
  \end{center}
\end{figure}


To use the \verb+mcgui+ front-end, the programs Perl and Perl/Tk must be properly installed on the system. 

Additionally, if the \MCS /PGPLOT back-end is used for data format, PGPLOT,
PgPerl, and PDL will be required. \index{Tools!Perl libraries} It may be
necessary to set the \verb+PGPLOT_DIR+ and \verb+PGPLOT_DEV+ environment
variable; consult the documentation for PGPLOT on the local system in case of
difficulty. \index{Environment variable!PGPLOT\_DIR} \index{Environment
variable!PGPLOT\_DEV}

\subsection{Running simulations with automatic compilation (mcrun)}
\label{s:mcrun}
\index{Tools!mcrun|textbf}

The \verb+mcrun+ front-end provides a convenient command-line
interface for running simulations with the same automatic compilation
features available in the \verb+mcgui+ front-end. It also provides a
facility for running a series of simulations while varying an input
parameter, thereby replacing the old \verb+gscan+ front-end.

The command
\begin{quote}
  \texttt{mcrun {\it sim} {\it args\/} \ldots}
\end{quote}
will compile the instrument definition \texttt{{\it sim}.instr} (if
necessary) into an executable simulation \texttt{{\it sim}.out}. It
will then run \texttt{{\it sim}.out}, passing the argument list {\it
  args}

The possible arguments are the same as those accepted by the simulations
themselves as described in section~\ref{s:run-sim}, with the following
extensions:
\begin{itemize}
\item The \verb+-c+ or \verb+--force-compile+ option may be used to force
  the recompilation of the instrument definition, regardless of file
  dates. This may be needed in case any component definitions are
  changed (in which case \verb+mcrun+ does not automatically recompile),
  or if a new version of McStas has been installed.
\item The \texttt{-p {\it file}} or \texttt{--param={\it file}} option
  may be used to specify a file containing assignment of values to the
  input parameters of the instrument definition. The file should consist
  of specifications of the form \texttt{{\it name\/}={\it value\/}}
  separated by spaces or line breaks. Multiple \verb+-p+ options may be
  given together with direct parameter specifications on the command
  line. If a parameter is assigned multiple times, later assignments
  override previous ones.
\item The \texttt{-N {\it count}} or \texttt{--numpoints={\it count}} option
  may be used to perform a series of \textit{count\/} simulations while
  varying one or more parameters within specified intervals. Such a
  series of simulations is called a \emph{scan}. To specify
  an interval for a parameter \textit{X}, it should be assigned two
  values separated with a comma. For example, the command
\begin{verbatim}
    mcrun sim.instr -N4 X=2,8 Y=1
\end{verbatim}
would run the simulation defined in \verb+sim.instr+ four times, with
\textit{X} having the values 2, 4, 6, and 8, respectively.

After running the simulation, the results will be written to the file
\verb+mcstas.dat+ by default. This file contains one line for each
simulation run giving the values of the scanned input variables along
with the intensity and estimated error in all detectors. Additionally, a
file \verb+mcstas.sim+ is written that can be read by the \verb+mcplot+
front-end to plot the results on the screen or in a Postscript file, see
section~\ref{s:mcplot}. \index{Tools!mcplot}
Currently, \verb+mcrun+ only supports the \MCS /PGPLOT format \emph{for scans}.
\item When doing a scan, the \texttt{-f {\it file}} and
  \texttt{--file={\it file}} options make \verb+mcrun+ write the output
  to the files \texttt{{\it file\/}.dat} and \texttt{{\it file\/}.sim}
  instead of the default names.
\item When doing a scan, the \texttt{-d {\it dir}} and
  \texttt{--dir={\it dir}} options make \verb+mcrun+ put all output in a
  newly created directory \textit{dir}. Additionally, the directory will
  have subdirectories \verb+1+, \verb+2+, \verb+3+,\ldots containing all
  data files output from the different simulations. When the \verb+-d+
  option is not used, no data files are written from the individual
  simulations (in order to save disk space).
\end{itemize}

The \verb+-h+ option will list valid options. The \verb+mcrun+ front-end requires a working installation of Perl to run.


\subsection{The \texttt{gscan} front-end}
\label{gscan}
\index{Tools!gscan (obsolete)}

The front-end \verb+gscan+ is obsolete from version~1.3 of McStas, and
is included only for backwards compatibility. The front-end~\verb+mcrun+
(section~\ref{s:mcrun}) includes all the functionality of the old
\verb+gscan+ front-end and should be used instead.


\subsection{Graphical display of simulations (mcdisplay)}
\label{s:mcdisplay}
\index{Tools!mcdisplay|textbf}

The front-end \verb+mcdisplay+ is a graphical debugging tool.
It presents a schematic drawing of the instrument
definition, showing the position of the components and the paths of the
simulated neutrons through the instrument. It is thus very useful for
debugging a simulation, for example to spot components in the wrong
position or to find out where neutrons are getting lost.

To use the \verb+mcdisplay+ front-end with a simulation, run it as
follows:
\begin{quote}
  \verb+mcdisplay sim +{\it args \ldots}
\end{quote}
where \verb+sim+ is the name of either the instrument source \texttt{{\it sim}.instr} or the simulation program \texttt{{\it sim}.out} generated with
\MCS, and \textit{args \ldots} are the normal command line arguments for
the simulation, as explained above. The \verb+-h+ option will list valid options.

The drawing back-end program may be selected among PGPLOT, Matlab and Scilab using either the -p{\it PLOTTER} option or using the current \verb+MCSTAS_FORMAT+ environment variable. \index{Environment variable!MCSTAS\_FORMAT}
For instance, calling 
\begin{quote}
  \verb+mcdisplay -pScilab ./vanadium\_example.out ROT=90+
\end{quote}
or (\verb+csh+/\verb+tcsh+ syntax)
\begin{quote}
  \verb+setenv MCSTAS_FORMAT Scilab+\\ 
  \verb+mcdisplay ./vanadium\_example.out ROT=90+
\end{quote}
will output graphics using Scilab. 
The \verb+mcdisplay+ front-end can also be run from the \verb+mcgui+ front-end.
\index{Tools!mcgui}
Examples of plotter appearence for \verb+mcdisplay+ is shown in figures
 \ref{fig:mcdisp_PGPLOT}-\ref{fig:mcdisp_Matlab}.

\paragraph{\MCS /PGPLOT back-end}

This will view the instrument from above. A
multi-display that shows the instrument from three directions
simultaneously can be shown using the \verb+--multi+ option:
\begin{quote}
  \verb+mcdisplay --multi sim.out +{\it args \ldots}
\end{quote}

Click the left mouse button in the graphics window or hit the space key
to see the display of successive neutron trajectories. The `P' key saves
a postscript file containing the current display that can be sent to the
printer to obtain a hardcopy; the `C' key produces color postscript. 
To stop the simulation
prematurely, type `Q' or use control-C as normal in the window in which
\verb+mcdisplay+ was started.

To see details in the instrument, it is possible to zoom in on a part of
the instrument using the middle mouse button (or the `Z' key on systems
with a one- or two-button mouse). The right mouse button (or the `X'
key) resets the zoom. Note that after zooming, the units on the
different axes may no longer be equal, and thus the angles as seen on
the display may not match the actual angles.

Another way to see details while maintaining an overview of the
instrument is to use the \verb+--zoom=+\textit{factor} option. This
magnifies the display of each component along the selected axis only,
{\em e.g.} a Soller collimator is magnified perpendicular to the neutron beam
but not along it. This option may produce rather strange visual effects
as the neutron passes between components with different coordinate
magnifications, but it is occasionally useful.

When debugging, it is often the case that one is interested only in
neutrons that reach a particular component in the instrument. For
example, if there is a problem with the sample one may prefer not to see
the neutrons that are absorbed in the monochromator shielding. For these
cases, the \verb+--inspect=+\textit{comp\/} option is useful. With this
option, only neutrons that reach the component named \textit{comp\/} are
shown in the graphics display.

The \verb+mcdisplay+ front-end will then require the Perl, the PGPLOT, and the
PGPerl packages to be installed. It may be necessary to set the
\verb+PGPLOT_DIR+ and \verb+PGPLOT_DEV+ environment variable; consult the
documentation for PGPLOT on the local system in case of difficulty.
\index{Environment variable!PGPLOT\_DIR} \index{Environment
variable!PGPLOT\_DEV} \index{Tools!Perl libraries}

\paragraph{Matlab and Scilab back-ends}

A 3D view of the instrument, and various operations (zoom, export, print, trace neutrons, \ldots) is available from dedicated Graphical User Interfaces.
The \verb+--inspect+ option may be used (see previous paragraph).

The \verb+mcdisplay+ front-end will then
require the Perl, and either Scilab (with the {\em plotlib} toolbox) or Matlab to be installed. \index{Tools!Matlab} \index{Tools!Scilab}

See section~\ref{s:comp-mcdisplay} for how to make new components work
with the \verb+mcdisplay+ front-end.

\subsection{Plotting the results of a simulation (mcplot)}
\label{s:mcplot}
\index{Tools!mcplot|textbf}

The front-end \verb+mcplot+ is a program that produces
plots of all the detectors in a simulation, and it is thus useful to get
a quick overview of the simulation results.

In the simplest case, the front-end is run simply by typing
\begin{verbatim}
    mcplot
\end{verbatim}
This will plot any simulation data stored in the current directory,
which is where simulations put their results by default. If the
\verb+--dir+ or \verb+--file+ options have been used (see
section~\ref{s:run-sim}), the name of the file or directory should be
passed to mcplot, {\em e.g.} ``\texttt{mcplot {\it dir}}'' or ``\texttt{mcplot
  {\it file}}''.
It is also possible to plot one single data file from a given monitor, passing its name to mcplot.

The drawing back-end program may be selected among PGPLOT, Matlab and Scilab using either the -p{\it PLOTTER} option or using the current \verb+MCSTAS_FORMAT+ environment variable. \index{Environment variable!MCSTAS\_FORMAT} Moreover, the drawing back-end program will also be set depending on the {\it file} extension (see table~\ref{t:formatoptions}).

It should be emphasized that \verb+mcplot+ may \emph{only} display simulation results with the format that was chosen during the computation. Indeed, if you request data in a given format from a simulation, you will only be able to display results using that same drawing back-end.

The \verb+mcplot+ front-end can also be run from the \verb+mcgui+ front-end.
\index{Tools!mcgui}

The initial display shows plots for each detector in the simulation.
Examples of plotter appearence for \verb+mcplot+ is shown in figures
 \ref{fig:mcdisp_PGPLOT}-\ref{fig:mcplot_figs}.

\paragraph{\MCS /PGPLOT back-end}

Clicking the left mouse button on a plot produces a full-window version
of that plot. The `P' key saves a postscript file containing the current
plot that can be sent to the printer to obtain a hardcopy; the `C' key
produces color postscript. 
The `Q' key quits the program (or CTRL-C in the controlling
terminal may be used as normal).

To use the \verb+mcplot+ front-end with PGPLOT, the programs Perl, PGPLOT,
PgPerl, and PDL must all be properly installed on the system.  It may be
necessary to set the \verb+PGPLOT_DIR+ and \verb+PGPLOT_DEV+ environment
variable; consult the documentation for PGPLOT on the local system in case of
difficulty. \index{Environment variable!PGPLOT\_DIR} \index{Environment
variable!PGPLOT\_DEV} \index{Tools!Perl libraries}

\paragraph{Matlab and Scilab back-ends}

A dedicated \MCS /Mcplot Dialog or menu attached to the plotting window is available, and provides many operations (duplication, export, colormaps, \ldots).
The corresponding 'mcplot' Matlab and Scilab functions may be called from these language prompt with the same method as in section~\ref{s:run-sim}, e.g:
\begin{verbatim}
    matlab> s=mcplot;
    matlab> help mcplot
    scilab> s=mcplot();
    matlab or scilab> s=mcplot('mcstas.m');
    matlab or scilab> mcplot(s);
\end{verbatim} \index{Tools!Matlab} \index{Tools!Scilab}
When the \verb|+nw| option is specified, a separate Matlab or Scilab window will appear (instead of being launched in the current terminal). This will then enable Java support under Matlab and Tk support under Scilab, resulting in additional menus and tools.

To use the \verb+mcplot+ front-end, the programs Perl, and either Scilab or Matlab are required. \index{Tools!Matlab} \index{Tools!Scilab}


\subsection{Plotting resolution functions (mcresplot)}
\label{s:mcresplot}
\index{Tools!mcresplot|textbf}

\begin{figure}[htb!]
  \begin{center}
    \includegraphics[angle=-90,width=0.55\textwidth]{figures/mcresplot_PGPLOT.ps}
  \end{center}
\caption{Output from \texttt{mcresplot} with PGPLOT backend. 
  Use P, C and G keys to write hadrcopy files.}
\label{fig:mcresplot_PGPLOT}
\end{figure}

The \verb+mcresplot+ front-end is used to plot the resolution function, particularly for triple-axis 
%or inverse geometry time-of-flight 
spectrometers, as
calculated by the Res\_sample component. It requires to have a Res\_monitor component further in the instrument description (at the detector position).
%(see section~\ref{s:res_sample}). 
This front-end 
has been included in the release since it may be useful
despite its somewhat rough user interface.

The \verb+mcresplot+ front-end is launched with the command
\begin{quote}
  \texttt{mcresplot {\it file\/}}
\end{quote}
Here, {\it file\/} is the name of a file output from a simulation using
the Res\_monitor component.
% (section~\ref{s:res_monitor}). 

This front-end currently only works with the PGPLOT plotter, but ports for Matlab and Scilab may be written in the future.

The front-end will open a window displaying projections of the 4-dimensional
resolution function $R(\boldsymbol{Q}, \omega)$. The covariance matrix of the
resolution function, the resolution along each projection axis and the resulting
resolution matrix are also shown, as well as the instrument name and parameters
used for the simulation. This is mainly useful for triple-axis spectrometers.

To use the \verb+mcresplot+ front-end, the programs Perl, PGPLOT, PgPerl,
and PDL must all be properly installed on the system.
\index{Tools!Perl libraries}

\subsection{Creating and viewing the library and component help (mcdoc)}
\label{s:mcdoc-run}
\index{Tools!mcdoc|textbf}

\MCS\ provides an easy way to generate automatically an HTML help page about a given component, or the whole \MCS\ library. \index{Library!Components}
\begin{quote}
  \verb|mcdoc|\\
  \verb|mcdoc| {\it comp}\\
  \verb|mcdoc -l|
\end{quote}
The first example generates an {\it index.html} catalog file using the available components (both locally, and in the \MCS\ library. When called with the \verb+--show+ or \verb+-s+ option, the library catalog of components is opened using the \verb+BROWSER+ environment variable \index{Environment variable!BROWSER} (e.g. netscape, konqueror, nautilus, msie, \ldots).

Alternatively, if a component {\it comp} is specified, it will be searched within the library, and an HTML help will be created for all available components matching {\it comp}. When using the \verb+-s+, the help will be opened. If the \verb+BROWSER+ is not defined, the help is displayed as text in the current terminal. This latter output may be forced with the \verb+-t+ or \verb+--text+ option.

The last example will list the name and action of all \MCS\ tools (same as \verb+--tools+ option).

Additionally, the \verb+--web+ and \verb+--manual+ options will open the \MCS\ web site page and the User Manual (this document), both requiring \verb+BROWSER+ to be defined. Finally, the \verb+--help+ option will display the command help, as usual.

See section~\ref{s:mcdoc} for more details about the McDoc usage and header format.
To use the \verb+mcdoc+ front-end, the program Perl should be available.

\subsection{Translating \MCS\ components for Vitess (mcstas2vitess)}
\label{s:mcstas2vitess}
\index{Tools!mcstas2vitess|textbf}

Any \MCS\ component may be translated for usage with Vitess. The syntax is simply \index{Library!Components}
\begin{quote}
  \texttt{mcstas2vitess {\it file.comp\/}}
\end{quote}
This will create a Vitess module of the given component.
To use the \verb+mcstas2vitess+ front-end, the program Perl should be available.

\section{Analyzing and visualizing the simulation results}
\label{s:analyze}
\index{Data format}

To analyze simulation results, one uses the same tools as for analyzing
experimental data, \textit{i.e}. programs such as IDL, Matlab and Scilab.
The output files from simulations are usually simple text files containing headers and data blocks. If data blocks are empty they may be accessed refering to an external file indicated in the header. This file may also be a binary file (except with the original \MCS /PGPLOT format), which does not contain any header (except if simulation is launched with \verb|+a| option), but are in turn smaller in size and faster to import. 

In order for the user to choose the data format, we recommand to set it {\it via} the MCSTAS\_FORMAT environment variable, which will also make the front-end programs able to import and plot data and instrument consistently. The available format list is shown in table~\ref{t:formatoptions}. \index{Environment variable!MCSTAS\_FORMAT}


Note that the neutron event counts in detectors is typically not very
meaningful except as a way to measure the performance of the
simulation. Use the simulated intensity instead whenever analysing
simulation data.

\paragraph{\MCS\ and PGPLOT format}

The \MCS\ original format, which is equivalent to the PGPLOT format, is simply columns of ASCII text that most programs should
be able to read. 

One-dimensional histogram detectors (time-of-flight, energy-sensitive)
write one line for each histogram bin. Each line contains a number
identifying the bin (\textit{i.e}.\ the time-of-flight) followed by
three numbers: the simulated intensity, an estimate of the statistical
error as explained in section~\ref{s:staterror}, and the number of
neutron events for this bin.

Two-dimensional histogram detectors (position sensitive detectors)
output $M$ lines of $N$ numbers representing neutron intensities, where
$M$ and $N$ are the number of bins in the two dimensions. The
two-dimentional detectors also store the error estimates and event counts as additional matrices.

Single-point detectors output the neutron intensity, the estimated
error, and the neutron event count as numbers on the
terminal. (The results from a series of simulations may be combined in a
data file using the \verb+mcrun+ front-end as explained in
section~\ref{s:mcrun}).

Both one- and two-dimentional detector output by default start with a
header of comment lines, all beginning with the `\verb+#+' character.
This header gives such information as the name of the instrument used in
the simulation, the values of any instrument parameters, the name of the
detector component for this data file, \textit{etc}. The headers may be
disabled using the \verb+--data-only+ option in case the file must be
read by a program that cannot handle the headers.

In addition to the files written for each one- and two-dimensional
detector component, another file (by default named \verb+mcstas.sim+) is
also created. This file is in a special \MCS\ ASCII format. It contains
all available information about the instrument definition used for the
simulation, the parameters and options used to run the simulation, and
the detector components present in the instrument. It is read by the
\verb+mcplot+ front-end (see section~\ref{s:mcplot}). This file stores
the results from single detectors, but by default contains only pointers
(in the form of file names) to data for one- and two-dimensional
detectors. By storing data in separate files, reading the data with
programs that do not know the special \MCS\ file format is
simplified. The \verb+--file+ option may be used to store all data
inside the \verb+mcstas.sim+ file instead of in separate files.

\paragraph{Matlab, Scilab and IDL formats}
\index{Tools!Matlab} \index{Tools!Scilab} \index{Tools!IDL} \index{Data format}

These formats write automatically scripts containing the data as a structure, as well as in-line import and plot functions for the selected language. Usage examples are given in section~\ref{s:run-sim}. 
Thus, it is not necessary to write a load routine for each format, as the script is itself a program that knows how to handle the data. Alternatively, using \verb+mcplot+ with Matlab and Scilab plotters provide additional functionalities from menus and dialogs (see section~\ref{s:mcplot}).

When imported through the data generated script (see section~\ref{s:run-sim}), or using \verb+mcplot+ (see section~\ref{s:mcplot}), a single variable may be created into the Matlab, Scilab or IDL base workspace. This variable is a structure constituting a data tree containing many fields, some of them being themselves structures. Field names are the initial names from the instrument (components, files, \ldots), transformed into valid variable names, e.g containing only letters, digits and the '\_' character, except for the first character which may only be a letter, or the 'm' letter\footnote{For instance in most case, the simulation location is './mcstas.m' which turns into field 'm\_mcstas'.}. 
In this tree, you will find the monitor names, which fields contain the monitored data. The usual structure is
\begin{quote}
  \texttt{s.{\it instrument}.{\it simulation}.{\it comp\_name}.{\it file\_name}}
\end{quote}

For instance, reading the data from a 'test' instrument using Matlab format will look like
\begin{verbatim}
matlab> s=mcstas; % or mcplot mcstas.m from the terminal
matlab> s
s =
     Format: 'Matlab with text headers'
        URL: 'http://neutron.risoe.dk'
     Editor: 'farhi on pcfarhi'
    Creator: 'test (test.instr) McStas 1.7 - May. 14, 2003 simulation'
       Date: 1.0529e+09
       File: './mcstas'
       test: [1x1 struct]
    EndDate: 1.0529e+09
      class: 'root'
matlab> s.test.m_mcstas.monitor1.monitor1_y_kz
ans =
          ...
          Date:       1.0529e+09
          File:       'monitor1.y_kz'
          type:       'array_2d(20, 10)'
          ...
          ratio:      '1e+06/1e+06'
          signal:     'Min=0; Max=5.54051e-10; Mean= 6.73026e-13;'
          statistics: 'X0=0.438302; dX=0.0201232; Y0=51019.6; dY=20557.1;
          ...
\end{verbatim}      
The latter example accesses the data from the 'monitor1.y\_kz' file written by the 'monitor1' component in the 'test' instrument during the './mcstas' simulation.

\paragraph{HTML, XML/NeXus and NeXus formats}

Both HTML and XML/NeXus formats are available. The former may be viewed using any web browser (Netscape, Internet Explorer, Nautilus), while the latter may be browsed for instance using Internet Explorer (Windows and Mac OS) or GXMLViewer (under Linux).

A future version of \MCS\ will support output in the NeXus
format~\cite{nexus_webpage}.
