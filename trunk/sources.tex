% Emacs settings: -*-mode: latex; TeX-master: "manual.tex"; -*-

\chapter{Source components}
\label{c:source}
\index{Sources}
\index{Library!Components!sources}

\MCS\ contains a number of different source components,
and any simulation will contain exactly one source.
The main function of a source is to determine a set of initial
parameters $({\bf r}, {\bf v}, t)$, or equivalent (${\bf r}, v, \Ombold , t $),
for each neutron. This is done by Monte Carlo choices from
suitable distributions. For example, the initial position is
always found from a uniform distribution over the source surface.
For time-of-flight sources, the choice of $t$ is being made on basis of
detailed analytical expressions.
For other sources, the initial neutron time is set to zero (default). In the case you would like to use a 'conventional' source (e.g. steady state source) with time-of-flight settings, it is then \emph{important} to set the time of each neutron using a random number from a distribution. This may be achieved thanks to the \verb+EXTEND+ keyword in the instrument description source:\index{Keyword!EXTEND}

\begin{verbatim}
  TRACE

  COMPONENT MySource=Source_gen(...) AT (...)
  EXTEND
  %{
    t = 1e-3*randpm1(); /* set time to +/- 1 ms */
  %}
\end{verbatim}

Polarization is not relevant for sources,
and we let the neutron spin ${\bf s}=(0,0,0)$.

The shape of most sources can be chosen to be either circular or rectangular.
The initial neutron velocity is selected within an interval
of either the corresponding energy or the corresponding wavelength.

The flux of the sources deserves special attention. The total neutron
intensity is defined as the sum of weights of all emitted neutron rays
during one simulation
(the unit of total neutron weight is thus neutrons per second).
The flux is then defined as intensity per area of the source.
For samples that uses a realistic energy/wavelength distribution,
the neutron intensity is given as the integrated neutron intensity
inside the energy/wavelength range. Similarly, as most sources can focus neutrons to an input window (usually the guide entrance), the intensity is scaled to account for the corresponding solid angle.

The flux~$\Phi$ is the number of neutrons emitted per second from a
one~cm$^2$ area on the source surface, with direction within a one
steradian solid angle, and with wavelength within a one {\AA}ngstr{\o}m
interval. The total number of neutrons emitted towards a given diaphragm
in one second is therefore
$$ N_{\rm total} = \Phi A \Omega \Delta\lambda $$
where $A$ is the source area, $\Omega$ is the solid angle of the
diaphragm as seen from the source surface, and $\Delta\lambda$ is the
width of the wavelength interval in which neutrons are emitted (assuming
a uniform wavelength spectrum). If $N_{\rm sim}$ denotes the number of
neutron histories to simulate, the initial neutron weight $p_0$ must be set to
$$ p_0 = \frac{N_{\rm total}}{N_{\rm sim}} =
    \frac{\Phi}{N_{\rm sim}} A \Omega \Delta\lambda $$

The simulations are performed so that detector intensities
are independent of the number of neutron histories simulated
(though of course more neutron histories will give better statistics).

As a start, we recommand new \MCS\ users to use the Source\_simple component, then use the Source\_Maxwell\_3 or the Source\_gen.

Optimizers can dramatically improve the statistics, but may occasionally give wrong results, due to misleaded optimization. You should always check such simulations with non-optimized ones.

Other ways to speed-up simulations are to read events from a file. See section \ref{sources-seealso} for possible file formats.

\begin{figure}
  \begin{center}
    \includegraphics[width=0.9\textwidth]{figures/sources.eps}
  \end{center}
\caption{A circular source component (at z=0) emitting neutron events randomly, either from a model, or from a data file.}
\label{f:source}
\end{figure}

\newpage
\input{source_simple}

\newpage
\input{source_div}

\newpage
\input{source_maxwell}

\newpage
\input{source_gen}

\newpage
\input{Source_adapt}

\newpage
\input{moderator}

\newpage
\input{Source_Optimizer}

\newpage
\input{Monitor_Optimizer}

\newpage
\section{Other sources components}
\label{sources-seealso}

There are other ways to define a source.

Pulsed source components are available for new facilities:\index{Sources!Pulsed sources}
\begin{enumerate}
\item SNS ({\bf contrib/SNS\_source})
\item ISIS ({\bf contrib/ISIS\_moderator})
\item ESS (project) ({\bf ESS\_moderator\_long} and {\bf  ESS\_moderator\_short}).
\end{enumerate}

When no model exists (e.g. not a Maxwellian distribution), you may have access to measurement, estimated flux distributions, event files, and - better - to MCNP/Triploli4 neutron event records. The following components are then for you.

\begin{enumerate}
\item{{\bf misc/Virtual\_input} can read a \MCS\ event file (in text or binary format), often bringing a factor 10 speed-up. See section \ref{virtual_input}.}
\item{{\bf contrib/Virtual\_tripoli4\_input} does the same, but from event files (text format) obtained from the \emph{Tripoli4} \cite{tripoli_webpage} reactor simulation program. Such files are usually huge.\index{Sources!Virtual source from Tripoli4}}
\item{{\bf misc/Vitess\_input} can read \emph{Vitess} \cite{vitess_webpage} neutron event binary files.\index{Sources!Virtual source from Vitess}}
\item{{\bf optics/Filter\_gen} reads a 1D distributionb from a file, and may either modify or set the flux according to it.\index{Sources!from 1D table input}}
\item{A component for reading MCNP "PTRAC" records is planed for a next release. Contact us if you wish to participate.}
\end{enumerate}
