% Emacs settings: -*-mode: latex; TeX-master: "manual.tex"; -*-

\chapter{New features in \MCS\ version \version\ }
\label{c:changes}

Many new features have been implemented in \MCS\ version \version\ 
as compared to version 1.5 (no version 1.6. manual was written,
the most important being that \MCS can now compile and run in
a Windows enviroment. 
The list of changes given here may be particularly 
useful to experienced \MCS\ users who do not wish to read the whole 
manual, searching only for new features. A global upward compatibility 
exists for all changes, and thus all previous components and 
instruments should work as before. 

\section{Kernel} 
\label{s:new-features:kernel}
\index{Kernel}

The following changes concern the 'Kernel' (i.e. the \MCS\ meta-language and program). See the chapter~\ref{s:kernel}, page~\pageref{s:kernel}, for more details.

\begin{itemize}
\item \MCS\ can now compile for Windows!
\item An instrument source file may contain \texttt{EXTEND} \%\{ \ldots \}\% C blocks
    just after   the usual \texttt{AT} \ldots \texttt{ROTATED} \ldots keywords, to
    extend the behaviour of existing components, without touching their code. All
    local component variables are  available. This may for instance be used to add a
    new 'color' to neutrons,  i.e. assign a new characteristic variable to the
    neutron. \index{Keyword!EXTEND}
\item The instrument and components may have string (\verb+char*+) setting parameters. For
    components, their length is limited to 1024 characters.
    \index{Parameters!Instrument} \index{Parameters!Setting}
\item In both components and instruments, the \texttt{FINALLY} section, that is
    executed at the end of simulations, has been supplemented with a new \texttt{SAVE}
    section. This latter is executed at simulation end (just before the
    \texttt{FINALLY} section), but also each time an intermediate save is required (e.g.\  
    when a 'kill -USR2 \$pid' is used under Unix, see section ref{s:new-features:run-time}). 
    \index{Keyword!SAVE} \index{Keyword!FINALLY} \index{Signal handler!USR2 signal}
\item Components may have a \texttt{SHARE} section, which is imported only once per
    type of component. \texttt{SHARE} has the same role as \texttt{DECLARE}, but is
    useful when several instances of the same component is used in a single simulation.
    \index{Keyword!SHARE} \index{Keyword!DECLARE}
\item The component files may have some \texttt{\%include} inside '\%\{ \}\%'
    \texttt{DECLARE} or \texttt{SHARE} C blocks. The files to include are searched
    locally, and then in the library. If an extension is found, only the specified
    file is included, else both  .h and .c are embedded unless the --no-runtime has
    been specified. As in previous
    releases, the instrument files can embed external files, both in C
    blocks  and in the instrument parts (\texttt{DECLARE}, etc.) . \index{Keyword!%include}
\item Component instances in an instrument file may be \texttt{GROUP}'ed into 
    exclusive assembly, i.e.\ only one component of the group will intercept
    the neutron ray, the rest will be skipped. This is useful for multi monochromators
    multi detectors, multiple collimators, etc. 
    After the \texttt{ROTATED} keyword, the keyword \texttt{GROUP} should be added
    followed by a group name (e.g. \texttt{GROUP} MyGroup). \index{Keyword!GROUP}
\end{itemize}

\section{Run-time} 
\label{s:new-features:run-time}
\index{Library!Run-time}

Some important modifications were done to the 'Run-time' library 
(i.e.\ the functions used in the instrument program). 
Some details may be found in section~\ref{s:comp-save} 
as well as in the appendix~\ref{c:kernelcalls}.

\begin{itemize}
\item A global gravitation handling is now available, by setting the \verb+-g+ flag.
\item Many output formats are available for data. Use the \verb+--format="format"+
    flag, e.g. \verb+--format="Scilab"+. For instance:
    \begin{verbatim}
      mcrun test.instr --format="Matlab binary" -n 1e4
    \end{verbatim}
    will create a \verb+mcstas.m+ file. Launch Matlab and execute:
    \begin{verbatim}
      s=mcstas('plot')
    \end{verbatim}
    will import data into variable s, and plot all detectors.
    Binary formats are handled by IDL, Matlab, Scilab.
    The present available format list, displayed with
    the \verb+-h+ flag of the instrument program, is
    \begin{verbatim}
      "McStas" "Scilab" "Matlab" "IDL" "XML" "HTML" 
    \end{verbatim}
    The default format is McStas/PGPLOT, but may be specified globally using
    the \verb+MCSTAS_FORMAT+ environment variable. 
    \index{Environment variable!MCSTAS\_FORMAT} \index{Data format}
\item It is possible to save 3D data arrays, by calling the DETECTOR\_OUT\_3D macro.
    (handled as 2D by \verb+mcplot+ by ignoring the 3rd dimension). 
    \index{Library!Run-time!DETECTOR\_OUT}
\item The C type of the 'number of events' array in monitors (usually named
    \verb+L_N+) was changed from \verb+int+ to \verb+double+, to avoid overflow.
    All 'home-made' monitors should be updated accordingly.
\item The \verb+USR2+ signal generates an intermediate save for all monitors, during
    the simulation (executes the \texttt{SAVE} section). The \verb+USR1+ signal still
    gives informations. \index{Signal handler!USR1 signal}
\item A new \verb+randvec_target_rect+ function now focuses on a rectangle (more
    efficient than the former \verb+randvec_target_sphere+).
    \index{Library!Run-time!randvec\_target\_rect}
\end{itemize}


\section{Components and Library} 
\label{s:new-features:components}
\index{Components} \index{Library!Components}
  
  We here list some of the new components (found in the \MCS\ \verb+lib+ directory) 
which are detailed in the {\it Component manual}, also mentioned in
section~\ref{s:comp-overview}.
  
\begin{itemize}
\index{Library!Components!data}
\item A new \verb+data+ directory contains neutron data tables (transmissions, reflectivities, Laue patterns, \ldots).
\item The documentation is now included in the \verb+doc+ directory.
      \index{Library!Components!doc}
\item Many dedicated libraries are now available as shared code for reading tables,
    handling data files and monitors. These are C functions to be \texttt{\%include}d
    into components (see e.g. \verb+MCSTAS/monitors/Monitor_nD.comp+).
    \index{Library!Components!share}
\item Obsolete directory contains components that were renamed or old.
      \index{Library!Components!obsolete}
\item \verb+misc/Progress_bar+ component now exists, and may save data regularly.
      \index{Library!Components!misc}
\item \verb+optics/Monochromator_curved+ can read reflectivity and transmission tables.
\item \verb+optics+ components were renamed by categories, starting with
   Guide\_\ldots, Monochromator\_\ldots, Filter\_\ldots etc so that sorting is
   easier. \index{Library!Components!optics}
\item \verb+optics/Guide_gravity+ can handle a 2D array of channels.
\item \verb+optics/Filter_gen+ can read a table from a file and affect the neutron
    beam (replaces the obsolete \verb+Flux_adapter+). It may act as a filter or a
    source.
\item \verb+monitors/Monitor_nD+ can have automatic limits mode for either all or 
    selected monitored variables. It may also plot banana monitors for
    \verb+mcdisplay+ and monitor something else than the intensity, e.g. the mean
    energy on a XY psd. \index{Library!Components!monitors}
\item \verb+sources/Virtual_output+ can save neutron events into a file
    (beware the size of the generated files !). Format may be text or binary.
    \index{Library!Components!sources}
\item \verb+sources/Virtual_input+ can read the files generated by \verb+Virtual_output+.
\item \verb+samples+ can now target towards any component, given its index 
    (no need to compute \verb+target_x|y|z+ vector, use e.g. \verb+target_index=1+). 
    Position an \verb+Arm+ at the focusing position when targetting to 
    centered components.
    \index{Library!Components!samples}
\item \verb+samples/Res_monitor+, \verb+Powder1+ and \verb+V_sample+ may now have a
    sphere or box shape, and may focus to a circular or rectangular area.
\item Contributed components (\verb+Guide_honeycomb+) have been
    placed in the \verb+contrib+ directory. \index{Library!Components!contrib}
\end{itemize}

\section{Tools, installation}
\label{s:new-features:tools}
\index{Tools}
\index{Installing}
  A renewal of most \MCS\ Tools, used to edit and display instrument or results, 
  has been undertaken, aiming at proposing alternatives to the Perl+PerlTk+PGPLOT+PDL 
  libraries.
  This has improved significantly the portability of \MCS\ and thus simplified the
  installation of the package. Details about the installation and the available tools are given in section~\ref{s:frontends}.

\begin{itemize}
\item The list of required packages for a complete \MCS\ installation is now a C
    compiler, Perl, PerlTk and Scilab or Matlab.
\item Matlab, Scilab and IDL may read directly McStas results if the simulation
    was executed with the \verb+--format="..."+ option 
    (see~\ref{s:new-features:run-time} changes). The former PGPLOT interface is still
    supported. 
    \index{Tools!Matlab} \index{Tools!Scilab} 
    \index{Tools!IDL} \index{Tools!Perl libraries}   
\item \verb+mcplot+, \verb+mcdisplay+, \verb+mcgui+ are now less dependent on the
    \verb+perl/PDL/pgplot+ installed versions. \index{Tools!mcplot}
\item \verb+mcplot+ can plot a single simulation data file.
\item \verb+mcplot+, \verb+mcresplot+, \verb+mcdisplay+ can output GIF, PS and color
    PS files. They also have integrated help (-h options), and may generate output
    files in a non interactive mode (read data, create output file, exit).
\item \verb+mcplot+ and \verb+mcdisplay+ work with Matlab, PGPLOT and Scilab plotters
   (depends on the \verb+MCSTAS_FORMAT+ environment variable, or -pPLOTTER option, or
   PGPLOT if not set)
\item \verb+mcrun+ can not currently generate scan results in other formats than
   McStas/PGPLOT, but a port for Scilab/Matlab is under way. 
   \index{Tools!mcrun}
\item \verb+mcstas2vitess+ enables to convert a McStas component into a
   Vitess~\cite{vitess_webpage} one. \index{Tools!mcstas2vitess}
\item \verb+mcresplot+ can plot projections of the 4D resolution function of an 
   instrument obtained from the \verb+Res_sample+ and \verb+Res_monitor+ components.
   In version \version, it only works with the McStas/PGPLOT format, 
   but a port for Scilab/Matlab is under way. \index{Tools!mcresplot}
\item \verb+mcdoc+ can now display an HTML catalog of the current library, as well as help for single components. \index{Tools!mcdoc}
\end{itemize}

\section{Future extensions}
\label{s:future}
The following features are planned for the oncoming releases of \MCS :
\begin{itemize}
\item Support for Matlab and Scilab in \verb+mcrun+ and
  \verb+mcresplot+
\item Extension of \verb+mcgui+ for performing \verb+mcrun+-like scans
  directly from the gui. (This functionality is currently possible by
  use of the contributed \verb+batchmaker+)
\item Extension of \verb+mcdoc+ for instrument documentation
\item Support for MPI (parallel processing library) in the runtime
\item Language extension 'JUMP' for enabeling loops, 'teleporting'
  etc. in instrument descriptions
\end{itemize}








